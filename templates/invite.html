<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„é‚€è¯· - Team é‚€è¯·åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'sans-serif'],
                        mono: ['JetBrains Mono', 'SF Mono', 'monospace'],
                    },
                    colors: {
                        ios: {
                            bg: '#000000',
                            card: 'rgba(30, 30, 32, 0.70)',
                            border: 'rgba(255, 255, 255, 0.1)',
                            blue: '#0A84FF',
                            green: '#30D158',
                            red: '#FF453A',
                            yellow: '#FFD60A',
                            gray: '#98989D',
                        }
                    },
                    animation: {
                        'float': 'float 10s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
                            '50%': { transform: 'translateY(-20px) rotate(1deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: rgba(30, 30, 32, 0.6);
            --card-border: rgba(255, 255, 255, 0.12);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --panel-bg: rgba(0, 0, 0, 0.25);
            --panel-border: rgba(255, 255, 255, 0.06);
            --input-bg: rgba(255, 255, 255, 0.03);
            --input-border: rgba(255, 255, 255, 0.08);
            --input-hover-bg: rgba(255, 255, 255, 0.06);
            --mesh-opacity: 0.8;
        }

        .light {
            --bg-color: #f4f4f5;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(0, 0, 0, 0.08);
            --text-primary: #18181b;
            --text-secondary: #52525b;
            --text-muted: #a1a1aa;
            --panel-bg: rgba(0, 0, 0, 0.03);
            --panel-border: rgba(0, 0, 0, 0.06);
            --input-bg: rgba(0, 0, 0, 0.03);
            --input-border: rgba(0, 0, 0, 0.08);
            --input-hover-bg: rgba(0, 0, 0, 0.06);
            --mesh-opacity: 0.3;
        }

        body {
            background: var(--bg-color);
            overflow: hidden;
            touch-action: none;
            transition: background 0.3s ease;
        }

        .bg-mesh {
            position: fixed;
            inset: -50%;
            z-index: -1;
            background:
                radial-gradient(circle at 50% 50%, rgba(10, 132, 255, 0.15), transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(48, 209, 88, 0.1), transparent 40%),
                radial-gradient(circle at 20% 80%, rgba(94, 92, 230, 0.15), transparent 40%);
            animation: float 20s ease-in-out infinite alternate;
            opacity: var(--mesh-opacity);
            transition: opacity 0.3s ease;
        }

        .access-card {
            background: var(--card-bg);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--card-border);
            box-shadow:
                0 0 0 1px rgba(0, 0, 0, 0.1),
                0 20px 40px -10px rgba(0, 0, 0, 0.2),
                0 0 80px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .access-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 10;
        }

        .light .access-card::before {
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.5) 0%, transparent 40%);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #0A84FF, transparent);
            opacity: 0.5;
            animation: scan 4s linear infinite;
            z-index: 5;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(500%);
                opacity: 0;
            }
        }

        .cyber-panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .ghost-input-group {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            transition: all 0.2s;
        }

        .ghost-input-group:hover {
            background: var(--input-hover-bg);
            border-color: var(--input-border);
        }

        /* ä¸»é¢˜æ–‡å­—é¢œè‰²é€‚é… */
        .theme-text {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .theme-text-secondary {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .theme-text-muted {
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--input-hover-bg);
            transform: scale(1.05);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle i {
            font-size: 14px;
            transition: transform 0.3s ease, opacity 0.2s ease;
        }

        .light .theme-toggle .fa-moon {
            display: none;
        }

        .light .theme-toggle .fa-sun {
            display: block;
        }

        html:not(.light) .theme-toggle .fa-sun {
            display: none;
        }

        html:not(.light) .theme-toggle .fa-moon {
            display: block;
        }

        .action-btn {
            background: #0A84FF;
            box-shadow: 0 0 20px rgba(10, 132, 255, 0.3);
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .action-btn:hover {
            background: #007aff;
            transform: translateY(-1px);
            box-shadow: 0 4px 25px rgba(10, 132, 255, 0.4);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        .text-glow {
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .code-glow {
            text-shadow: 0 0 15px rgba(48, 209, 88, 0.4);
        }

        .ratio-16-9-desktop {
            aspect-ratio: 16/9;
        }

        @media (max-width: 1024px) {
            .ratio-16-9-desktop {
                aspect-ratio: auto;
                height: auto;
                min-height: 60vh;
                max-height: 90vh;
            }

            body {
                overflow-y: auto;
            }
        }

        .vert-divider {
            width: 1px;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        /* Left Panel Specific Styles */
        .identity-panel {
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.1) 0%, rgba(10, 132, 255, 0.03) 100%);
        }

        .avatar-ring {
            background: conic-gradient(from 180deg, rgba(10, 132, 255, 0.4), rgba(48, 209, 88, 0.4), rgba(94, 92, 230, 0.4), rgba(10, 132, 255, 0.4));
            padding: 3px;
            border-radius: 50%;
        }

        .avatar-inner {
            background: #1c1c1e;
            border-radius: 50%;
            overflow: hidden;
        }

        .trust-badge {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.2) 0%, rgba(94, 92, 230, 0.2) 100%);
            border: 1px solid rgba(10, 132, 255, 0.3);
        }

        /* å¤åˆ¶æŒ‰é’®åŠ¨ç”» */
        .copy-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .copy-btn i {
            transition: all 0.2s ease;
        }

        /* Toast åŠ¨ç”» */
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(100px) scale(0.8);
            }
        }

        .toast-enter {
            animation: toastSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .toast-exit {
            animation: toastSlideOut 0.3s cubic-bezier(0.4, 0, 1, 1) forwards;
        }

        /* å¤åˆ¶éªŒè¯ç æŒ‰é’® */
        #copy-code-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>

<body class="text-white h-screen w-screen flex flex-col items-center justify-center p-4 sm:p-8">
    <div class="bg-mesh"></div>

    <!-- MAIN CONTAINER (16:9 on Desktop) -->
    <div
        class="access-card w-full max-w-[1280px] rounded-[32px] ratio-16-9-desktop flex flex-col md:flex-row relative group transition-all duration-700">
        <div class="scan-line"></div>

        <!-- LEFT PANEL: IDENTITY (35%) -->
        <div class="identity-panel relative w-full md:w-[35%] p-6 md:p-10 flex flex-col justify-between z-20">
            <!-- Header -->
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-xs font-mono theme-text-muted tracking-widest opacity-60">
                    <i class="fa-brands fa-linux"></i> LINUX.DO
                </div>
                <div class="flex items-center gap-2">
                    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                    <button id="theme-toggle" class="theme-toggle theme-text-secondary" title="åˆ‡æ¢ä¸»é¢˜">
                        <i class="fa-solid fa-moon"></i>
                        <i class="fa-solid fa-sun"></i>
                    </button>
                    <div
                        class="px-2.5 py-1 rounded-lg text-[10px] font-bold bg-white/5 border border-white/10 theme-text-secondary tracking-wider backdrop-blur-sm">
                        é€šè¡Œè¯
                    </div>
                </div>
            </div>

            <!-- User Profile -->
            <div class="flex flex-col items-center text-center my-auto py-6">
                <!-- Avatar Container -->
                <div class="relative mb-6 group-hover:scale-105 transition-transform duration-500">
                    <!-- Glow Effect -->
                    <div
                        class="absolute inset-0 bg-blue-500 rounded-full blur-3xl opacity-20 animate-pulse-slow scale-150">
                    </div>

                    <!-- Avatar Ring -->
                    <div class="avatar-ring relative">
                        <div class="avatar-inner w-28 h-28 md:w-36 md:h-36 flex items-center justify-center">
                            <!-- Avatar Image (set by JS or Jinja) -->
                            <img id="user-avatar" src="https://avatars.githubusercontent.com/u/0?v=4"
                                data-jinja-src="{{ user.avatar_template | replace('{size}', '128') }}" alt="avatar"
                                class="w-full h-full object-cover">
                        </div>
                    </div>

                    <!-- Trust Level Badge -->
                    <div
                        class="trust-badge absolute -bottom-3 left-1/2 -translate-x-1/2 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg backdrop-blur-md">
                        <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                        <span id="user-trust-level" class="text-[11px] font-bold tracking-wider text-blue-300">ç­‰çº§
                            3</span>
                    </div>
                </div>

                <!-- User Name -->
                <h2 id="user-display-name" class="text-2xl md:text-3xl font-bold tracking-tight mb-2 text-glow theme-text">
                    Shane User
                </h2>

                <!-- Username Tag -->
                <p id="user-handle" class="text-sm theme-text-muted font-mono flex items-center gap-2">
                    <span class="w-1 h-1 rounded-full bg-green-500"></span>
                    @shane
                </p>

                <!-- Member Since (Decorative) -->
                <div
                    class="mt-6 px-4 py-2 rounded-xl bg-white/5 border border-white/5 text-[10px] theme-text-muted tracking-wider">
                    å·²è®¤è¯ä¼šå‘˜
                </div>
            </div>

            <!-- Footer / System Status -->
            <div class="space-y-3">
                <div class="cyber-panel p-4 rounded-2xl">
                    <div class="flex items-center justify-between text-[11px] font-medium">
                        <span class="theme-text-muted tracking-wider">ç³»ç»ŸçŠ¶æ€</span>
                        <span id="seats-info" class="theme-text-secondary flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-zinc-500"></span> è¿æ¥ä¸­...
                        </span>
                    </div>
                </div>
                <a href="/logout"
                    class="flex items-center justify-center gap-2 text-xs theme-text-muted hover:text-red-400 transition-colors py-2 rounded-xl hover:bg-red-500/10">
                    <i class="fa-solid fa-power-off"></i> å®‰å…¨é€€å‡º
                </a>
            </div>
        </div>

        <!-- DIVIDER (Desktop only) -->
        <div class="hidden md:block vert-divider h-full"></div>

        <!-- RIGHT PANEL: OPERATIONAL (65%) -->
        <div class="relative w-full md:w-[65%] p-6 md:p-10 flex flex-col z-20 overflow-hidden">
            <!-- Top Links -->
            <div class="flex justify-end gap-4 mb-6 md:mb-10">
                <a href="https://kyx-cloud-email.kkyyxx.top/" target="_blank"
                    class="text-xs text-zinc-500 hover:text-blue-400 transition-colors flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-white/5">
                    <i class="fa-solid fa-inbox"></i> é‚®ç®±
                </a>
                <a href="https://chatgpt.com/" target="_blank"
                    class="text-xs text-zinc-500 hover:text-blue-400 transition-colors flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-white/5">
                    <img src="https://cdn.oaistatic.com/assets/favicon-l4nq08hd.svg" alt="ChatGPT" class="w-4 h-4 object-contain"> ChatGPT
                </a>
                <a href="https://linux.do/" target="_blank"
                    class="text-xs text-zinc-500 hover:text-blue-400 transition-colors flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-white/5">
                    <i class="fa-solid fa-comments"></i> ç¤¾åŒº
                </a>
            </div>

            <!-- Main Interactive Area -->
            <div class="flex-1 flex flex-col justify-center">

                <!-- Credentials Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Email Field -->
                    <div class="ghost-input-group p-4 rounded-2xl flex flex-col justify-center relative">
                        <div class="text-[10px] font-bold theme-text-muted tracking-wider mb-2">ä¸“å±é‚®ç®±</div>
                        <div class="flex items-center justify-between gap-3">
                            <div class="font-mono text-sm md:text-base theme-text truncate select-all"
                                id="assigned-email">
                                shane@kyx03.de
                            </div>
                            <button onclick="copyEmail()"
                                class="copy-btn w-9 h-9 rounded-xl bg-white/5 hover:bg-blue-500/20 flex items-center justify-center theme-text-muted hover:text-blue-400 shrink-0">
                                <i id="copy-icon" class="fa-regular fa-copy text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Password Field -->
                    <div class="ghost-input-group p-4 rounded-2xl flex flex-col justify-center relative">
                        <div class="text-[10px] font-bold theme-text-muted tracking-wider mb-2">ç™»å½•å¯†ç </div>
                        <div class="flex items-center justify-between gap-3">
                            <div class="font-mono text-sm md:text-base theme-text tracking-wide"
                                id="assigned-password">kfcvivo50</div>
                            <button onclick="copyPassword()"
                                class="copy-btn w-9 h-9 rounded-xl bg-white/5 hover:bg-blue-500/20 flex items-center justify-center theme-text-muted hover:text-blue-400 shrink-0">
                                <i id="copy-pwd-icon" class="fa-regular fa-copy text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Code Section -->
                <div class="cyber-panel rounded-2xl p-4 md:p-5 text-center relative overflow-hidden mb-4">
                    <div class="absolute inset-0 bg-gradient-to-t from-blue-500/5 to-transparent pointer-events-none">
                    </div>

                    <div class="text-[10px] font-mono text-blue-400 mb-1 opacity-80 tracking-widest">éªŒè¯ç </div>

                    <div id="code-display"
                        class="text-4xl md:text-5xl font-mono font-bold tracking-[0.15em] text-zinc-600 transition-all duration-300 relative z-10 py-1">
                        --- ---
                    </div>

                    <div id="code-status" class="text-[11px] text-zinc-500 mt-1 tracking-wide">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–</div>

                    <!-- éªŒè¯ç æ—¶é—´æ˜¾ç¤º -->
                    <div id="code-time" class="text-[10px] text-zinc-600 mt-1 hidden">
                        <i class="fa-regular fa-clock mr-1"></i>
                        <span id="code-time-text">--</span>
                    </div>

                    <!-- å¤åˆ¶éªŒè¯ç æŒ‰é’® -->
                    <button id="copy-code-btn" onclick="copyCode()"
                        class="mt-3 px-4 py-2 rounded-lg bg-white/5 hover:bg-blue-500/20 border border-white/10 hover:border-blue-500/30 text-zinc-400 hover:text-blue-400 transition-all text-xs font-medium inline-flex items-center gap-2 opacity-50 cursor-not-allowed"
                        disabled>
                        <i id="copy-code-icon" class="fa-regular fa-copy"></i>
                        <span>å¤åˆ¶éªŒè¯ç </span>
                    </button>
                </div>

                <!-- Action Button -->
                <button id="get-code-btn" onclick="getCode()"
                    class="w-full py-4 rounded-2xl action-btn text-white font-bold text-base tracking-wide flex items-center justify-center gap-3 relative overflow-hidden group/btn">
                    <i class="fa-solid fa-fingerprint text-lg opacity-80"></i>
                    <span>è·å–éªŒè¯ç </span>
                </button>
            </div>

            <!-- Bottom Decoration -->
            <div class="mt-4 flex justify-between items-center text-[10px] theme-text-muted">
                <span><i class="fa-solid fa-lock mr-1"></i>å®‰å…¨åŠ å¯†è¿æ¥</span>
                <span id="user-id-footer">ç”¨æˆ·: shane</span>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        // --- CONFIGURATION ---
        const SERVER_DATA = {
            username: '{{ user.username | lower }}',
            name: '{{ user.name or user.username }}',
            trustLevel: '{{ user.trust_level }}',
            avatarUrl: '{{ user.avatar_template | replace("{size}", "128") }}'
        };

        // é‚€è¯·ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
        const INVITE_RESULT = {
            success: {{ 'true' if invite_result.success else 'false' }},
            email: '{{ invite_result.email or "" }}',
            password: '{{ invite_result.password or "kfcvivo50" }}',
            message: '{{ invite_result.message or "" }}',
            seats_full: {{ 'true' if invite_result.seats_full else 'false' }},
            banned: {{ 'true' if invite_result.banned else 'false' }}
        };

        // æ˜¯å¦éœ€è¦æ‰§è¡Œé‚€è¯·ï¼ˆæ–°ç™»å½•ç”¨æˆ·ï¼‰
        const NEED_INVITE = {{ 'true' if need_invite else 'false' }};

        // Use server data directly (Jinja will populate these values)
        const USER = {
            username: SERVER_DATA.username,
            name: SERVER_DATA.name || SERVER_DATA.username,
            trustLevel: SERVER_DATA.trustLevel,
            avatarUrl: SERVER_DATA.avatarUrl
        };

        // ä½¿ç”¨é‚€è¯·ç»“æœçš„é‚®ç®±ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤ç”Ÿæˆçš„
        const email = INVITE_RESULT.email || (USER.username + 'kfc@kyx03.de');
        const password = INVITE_RESULT.password || 'kfcvivo50';

        // --- POPULATE UI ---
        document.getElementById('user-avatar').src = USER.avatarUrl;
        document.getElementById('user-display-name').textContent = USER.name;
        document.getElementById('user-handle').innerHTML = `<span class="w-1 h-1 rounded-full bg-green-500"></span> @${USER.username}`;
        document.getElementById('user-trust-level').textContent = `ç­‰çº§ ${USER.trustLevel}`;
        document.getElementById('assigned-email').textContent = email;
        document.getElementById('assigned-password').textContent = password;
        document.getElementById('user-id-footer').textContent = `ç”¨æˆ·: ${USER.username}`;

        // --- UTILITY FUNCTIONS ---
        function copyEmail() {
            const emailText = document.getElementById('assigned-email').textContent.trim();
            copyToClip(emailText, 'copy-icon', 'é‚®ç®±å·²å¤åˆ¶');
        }

        function copyPassword() {
            const pwdText = document.getElementById('assigned-password').textContent.trim();
            copyToClip(pwdText, 'copy-pwd-icon', 'å¯†ç å·²å¤åˆ¶');
        }

        function copyToClip(text, iconId, toastMsg) {
            if (!text) {
                showMessage('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'error');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                const icon = document.getElementById(iconId);
                const btn = icon.parentElement;

                // å›¾æ ‡åŠ¨ç”»
                icon.className = 'fa-solid fa-check text-green-400 scale-125';
                btn.classList.add('ring-2', 'ring-green-500/50', 'bg-green-500/20');

                // æ˜¾ç¤º toast
                showMessage(toastMsg || 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');

                setTimeout(() => {
                    icon.className = 'fa-regular fa-copy text-sm';
                    btn.classList.remove('ring-2', 'ring-green-500/50', 'bg-green-500/20');
                }, 1500);
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å½“å‰éªŒè¯ç å­˜å‚¨
        let currentCode = null;

        function copyCode() {
            if (!currentCode) {
                showMessage('è¯·å…ˆè·å–éªŒè¯ç ', 'error');
                return;
            }
            navigator.clipboard.writeText(currentCode).then(() => {
                const icon = document.getElementById('copy-code-icon');
                const btn = document.getElementById('copy-code-btn');

                // åŠ¨ç”»æ•ˆæœ
                icon.className = 'fa-solid fa-check text-green-400 scale-125';
                btn.classList.add('ring-2', 'ring-green-500/50', 'bg-green-500/20', 'border-green-500/50');
                btn.querySelector('span').textContent = 'å·²å¤åˆ¶!';

                showMessage('éªŒè¯ç å·²å¤åˆ¶', 'success');

                setTimeout(() => {
                    icon.className = 'fa-regular fa-copy';
                    btn.classList.remove('ring-2', 'ring-green-500/50', 'bg-green-500/20', 'border-green-500/50');
                    btn.querySelector('span').textContent = 'å¤åˆ¶éªŒè¯ç ';
                }, 1500);
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        function enableCopyCodeBtn(code) {
            currentCode = code;
            const btn = document.getElementById('copy-code-btn');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.classList.add('hover:scale-105', 'active:scale-95');
        }

        function showMessage(text, type) {
            // ç§»é™¤ç°æœ‰çš„ toastï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingToast = document.getElementById('global-toast');
            if (existingToast) {
                existingToast.remove();
            }

            // åˆ›å»ºæ–°çš„ toast
            const toast = document.createElement('div');
            toast.id = 'global-toast';

            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            const isError = type === 'error';
            const bgColor = isError
                ? 'bg-gradient-to-r from-red-500/95 to-red-600/95'
                : 'bg-gradient-to-r from-green-500/95 to-emerald-600/95';
            const icon = isError ? 'fa-circle-xmark' : 'fa-circle-check';
            const ringColor = isError ? 'ring-red-400/30' : 'ring-green-400/30';

            toast.className = `fixed top-6 right-6 z-[9999] px-5 py-3.5 rounded-2xl ${bgColor} backdrop-blur-xl shadow-2xl text-white text-sm font-medium flex items-center gap-3 toast-enter ring-1 ${ringColor}`;
            toast.innerHTML = `
                <div class="w-6 h-6 rounded-full ${isError ? 'bg-red-400/30' : 'bg-green-400/30'} flex items-center justify-center">
                    <i class="fa-solid ${icon} text-xs"></i>
                </div>
                <span class="font-medium">${text}</span>
            `;

            document.body.appendChild(toast);

            // 2.5ç§’åæ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        function loadStats() {
            fetch('/stats').then(r => r.json()).then(data => {
                if (!data.success) return;
                const d = data.data;
                const available = (d.seats_entitled || 0) - (d.seats_in_use || 0) - (d.pending_invites || 0);
                const info = document.getElementById('seats-info');
                if (available > 0) {
                    info.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> <span class="text-green-400">åœ¨çº¿ (å‰©ä½™ ' + available + ' ä¸ª)</span>';
                } else {
                    info.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> <span class="text-red-400">åé¢å·²æ»¡</span>';
                }
            }).catch(() => {
                document.getElementById('seats-info').innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-yellow-500"></span> <span class="text-yellow-400">ç¦»çº¿</span>';
            });
        }

        // --- æ˜¾ç¤ºéªŒè¯ç æ—¶é—´ ---
        function showCodeTime(timeStr) {
            const timeEl = document.getElementById('code-time');
            const timeTextEl = document.getElementById('code-time-text');
            if (timeStr) {
                timeTextEl.textContent = timeStr;
                timeEl.classList.remove('hidden');
            } else {
                timeEl.classList.add('hidden');
            }
        }

        // --- æ˜¾ç¤ºéªŒè¯ç  ---
        function displayCode(code, emailTime) {
            const codeDisplay = document.getElementById('code-display');
            const codeStatus = document.getElementById('code-status');
            const btn = document.getElementById('get-code-btn');

            const fmt = code.length === 6 ? code.slice(0, 3) + ' ' + code.slice(3) : code;
            codeDisplay.textContent = fmt;
            codeDisplay.className = 'text-4xl md:text-5xl font-mono font-bold tracking-[0.15em] text-[#30D158] code-glow transition-all duration-300 relative z-10 py-1';
            codeStatus.textContent = 'éªŒè¯ç å·²å°±ç»ª âœ“';

            // æ˜¾ç¤ºéªŒè¯ç æ—¶é—´
            showCodeTime(emailTime);

            // å¯ç”¨å¤åˆ¶æŒ‰é’®
            enableCopyCodeBtn(code);

            // æ¢å¤æŒ‰é’®
            btn.disabled = false;
            btn.querySelector('i').className = 'fa-solid fa-rotate text-xl';
            btn.querySelector('span').textContent = 'åˆ·æ–°éªŒè¯ç ';

            loadStats();
            showMessage('éªŒè¯ç è·å–æˆåŠŸ', 'success');
        }

        // --- è·å–éªŒè¯ç ï¼ˆç”¨æˆ·ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼‰ ---
        async function getCode() {
            const btn = document.getElementById('get-code-btn');
            const codeDisplay = document.getElementById('code-display');
            const codeStatus = document.getElementById('code-status');

            btn.disabled = true;
            btn.querySelector('span').textContent = 'è·å–ä¸­...';
            btn.querySelector('i').className = 'fa-solid fa-spinner animate-spin text-xl';
            codeStatus.textContent = 'æ­£åœ¨è·å–éªŒè¯ç ...';

            try {
                // 1. å…ˆæ£€æŸ¥æ˜¯å¦æœ‰éªŒè¯ç 
                const pollResp = await fetch('/api/poll-code');
                const pollData = await pollResp.json();

                if (pollData.found && pollData.code) {
                    // æœ‰éªŒè¯ç ï¼Œæ˜¾ç¤º
                    displayCode(pollData.code, pollData.email_time);
                    return;
                }

                // 2. æ²¡æœ‰éªŒè¯ç 
                if (pollData.success && !pollData.found) {
                    // æœ‰å¾…å¤„ç†é‚€è¯·ä½†æ²¡æœ‰éªŒè¯ç 
                    codeStatus.textContent = 'æš‚æ— éªŒè¯ç é‚®ä»¶';
                    showMessage('æš‚æ— éªŒè¯ç é‚®ä»¶ï¼Œè¯·ç¨åå†è¯•', 'error');
                    resetBtn(10);
                    return;
                }

                // 3. æ²¡æœ‰å¾…å¤„ç†é‚€è¯·ï¼Œæ‰§è¡Œæ–°é‚€è¯·
                codeStatus.textContent = 'æ­£åœ¨å‘é€é‚€è¯·...';
                const inviteResp = await fetch('/api/auto-invite', { method: 'POST' });
                const inviteData = await inviteResp.json();

                if (inviteData.banned) {
                    codeStatus.textContent = 'è½¦å·²ç¿» - æœåŠ¡æš‚ä¸å¯ç”¨';
                    codeDisplay.textContent = 'â›” å°ç¦';
                    codeDisplay.className = 'text-4xl md:text-5xl font-mono font-bold tracking-[0.15em] text-red-500 transition-all duration-300 relative z-10 py-1';
                    btn.querySelector('span').textContent = 'æœåŠ¡ä¸å¯ç”¨';
                    btn.querySelector('i').className = 'fa-solid fa-ban text-xl';
                    showMessage(inviteData.message, 'error');
                    return;
                }

                if (inviteData.seats_full) {
                    codeStatus.textContent = 'åé¢å·²æ»¡ï¼Œè¯·ç­‰å¾…ä¸‹ä¸€ç­';
                    codeDisplay.textContent = 'ğŸš« æ»¡å‘˜';
                    codeDisplay.className = 'text-4xl md:text-5xl font-mono font-bold tracking-[0.15em] text-amber-500 transition-all duration-300 relative z-10 py-1';
                    btn.querySelector('span').textContent = 'åé¢å·²æ»¡';
                    btn.querySelector('i').className = 'fa-solid fa-user-slash text-xl';
                    showMessage(inviteData.message, 'error');
                    return;
                }

                if (inviteData.success) {
                    // æ›´æ–°æ˜¾ç¤ºçš„é‚®ç®±
                    if (inviteData.result && inviteData.result.email) {
                        document.getElementById('assigned-email').textContent = inviteData.result.email;
                    }
                    codeStatus.textContent = 'é‚€è¯·å·²å‘é€ï¼Œè¯·ç¨åç‚¹å‡»è·å–éªŒè¯ç ';
                    showMessage('é‚€è¯·å‘é€æˆåŠŸï¼Œè¯·ç¨ç­‰30ç§’åå†æ¬¡ç‚¹å‡»è·å–éªŒè¯ç ', 'success');
                    resetBtn(30);
                } else {
                    codeStatus.textContent = inviteData.message || 'é‚€è¯·å¤±è´¥';
                    showMessage(inviteData.message || 'é‚€è¯·å¤±è´¥', 'error');
                    resetBtn(10);
                }
            } catch (err) {
                codeStatus.textContent = 'ç½‘ç»œé”™è¯¯';
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                resetBtn(5);
            }
        }

        // --- é‡ç½®æŒ‰é’®ï¼ˆå¸¦å†·å´æ—¶é—´ï¼‰ ---
        function resetBtn(cooldownTime = 10) {
            const btn = document.getElementById('get-code-btn');
            let cooldown = cooldownTime;
            btn.disabled = true;

            const countdownInterval = setInterval(() => {
                btn.querySelector('i').className = 'fa-solid fa-clock text-xl opacity-60';
                btn.querySelector('span').textContent = `${cooldown}ç§’åå¯å†æ¬¡è·å–`;
                cooldown--;

                if (cooldown < 0) {
                    clearInterval(countdownInterval);
                    btn.disabled = false;
                    btn.querySelector('i').className = 'fa-solid fa-fingerprint text-xl';
                    btn.querySelector('span').textContent = 'è·å–éªŒè¯ç ';
                }
            }, 1000);
        }

        // --- æ ¹æ®çŠ¶æ€åˆå§‹åŒ–é¡µé¢ ---
        function initPage() {
            const codeDisplay = document.getElementById('code-display');
            const codeStatus = document.getElementById('code-status');
            const btn = document.getElementById('get-code-btn');

            // æ–°ç™»å½•ç”¨æˆ·ï¼Œè‡ªåŠ¨æ‰§è¡Œé‚€è¯·ï¼ˆä½†ä¸è‡ªåŠ¨è·å–éªŒè¯ç ï¼‰
            if (NEED_INVITE) {
                codeStatus.textContent = 'æ­£åœ¨å‘é€é‚€è¯·...';
                btn.disabled = true;
                btn.querySelector('span').textContent = 'å¤„ç†ä¸­...';
                btn.querySelector('i').className = 'fa-solid fa-spinner animate-spin text-xl';

                fetch('/api/auto-invite', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.banned) {
                            codeStatus.textContent = 'è½¦å·²ç¿» - æœåŠ¡æš‚ä¸å¯ç”¨';
                            codeDisplay.textContent = 'â›” å°ç¦';
                            codeDisplay.className = 'text-4xl md:text-5xl font-mono font-bold tracking-[0.15em] text-red-500 transition-all duration-300 relative z-10 py-1';
                            btn.querySelector('span').textContent = 'æœåŠ¡ä¸å¯ç”¨';
                            btn.querySelector('i').className = 'fa-solid fa-ban text-xl';
                            showMessage(data.message, 'error');
                        } else if (data.seats_full) {
                            codeStatus.textContent = 'åé¢å·²æ»¡';
                            codeDisplay.textContent = 'ğŸš« æ»¡å‘˜';
                            codeDisplay.className = 'text-4xl md:text-5xl font-mono font-bold tracking-[0.15em] text-amber-500 transition-all duration-300 relative z-10 py-1';
                            btn.querySelector('span').textContent = 'åé¢å·²æ»¡';
                            btn.querySelector('i').className = 'fa-solid fa-user-slash text-xl';
                            showMessage(data.message, 'error');
                        } else if (data.success) {
                            if (data.result && data.result.email) {
                                document.getElementById('assigned-email').textContent = data.result.email;
                            }
                            codeStatus.textContent = 'é‚€è¯·å·²å‘é€ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–éªŒè¯ç ';
                            showMessage('é‚€è¯·å‘é€æˆåŠŸ', 'success');
                            resetBtn(30);
                        } else {
                            codeStatus.textContent = data.message || 'é‚€è¯·å¤±è´¥';
                            showMessage(data.message || 'é‚€è¯·å¤±è´¥', 'error');
                            resetBtn(10);
                        }
                    })
                    .catch(() => {
                        codeStatus.textContent = 'ç½‘ç»œé”™è¯¯';
                        showMessage('ç½‘ç»œé”™è¯¯', 'error');
                        resetBtn(5);
                    });
                return;
            }

            // éæ–°ç™»å½•ç”¨æˆ·ï¼Œæ˜¾ç¤ºé»˜è®¤çŠ¶æ€
            codeStatus.textContent = 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–éªŒè¯ç ';
        }

        // --- ä¸»é¢˜åˆ‡æ¢ ---
        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.documentElement.classList.add('light');
            } else if (saved === 'dark') {
                document.documentElement.classList.remove('light');
            } else {
                // è·Ÿéšç³»ç»Ÿ
                if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                    document.documentElement.classList.add('light');
                }
            }
        }

        function toggleTheme() {
            const isLight = document.documentElement.classList.toggle('light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        initTheme();

        // ç»‘å®šåˆ‡æ¢æŒ‰é’®
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

        // --- INIT ---
        loadStats();
        setInterval(loadStats, 30000);
        initPage();
    </script>
</body>

</html>